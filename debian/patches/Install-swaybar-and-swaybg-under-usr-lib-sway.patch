Subject: Install swaybar and swaybg under /usr/lib/sway
Forwarded: https://github.com/swaywm/sway/pull/1881
Applied-Upstream: no
Author: Nicolas Braud-Santoni <nicolas@braud-santoni.eu>
From: Nicolas Braud-Santoni <nicolas@braud-santoni.eu>
Reviewed-by: Nicolas Braud-Santoni <nicolas@braud-santoni.eu>
Last-Update: 2018-05-05

---
 meson.build                 |  8 ++++++++
 sway/commands/exec_always.c | 38 ++++++++++++++++++++++++++++++++++++++
 swaybar/meson.build         |  3 ++-
 swaybg/meson.build          |  3 ++-
 4 files changed, 50 insertions(+), 2 deletions(-)

diff --git a/meson.build b/meson.build
index 5a37b0e..79d4e3b 100644
--- a/meson.build
+++ b/meson.build
@@ -19,6 +19,14 @@ is_freebsd = host_machine.system().startswith('freebsd')
 datadir = get_option('datadir')
 sysconfdir = get_option('sysconfdir')
 prefix = get_option('prefix')
+libexecdir = get_option('libexecdir')
+
+if libexecdir == ''
+	libexecdir = 'lib'
+endif
+sway_libexecdir = join_paths(prefix, libexecdir, 'sway')
+add_project_arguments('-DSWAY_LIBEXECDIR="/@0@"'.format(sway_libexecdir), language : 'c')
+
 
 jsonc          = dependency('json-c', version: '>=0.13')
 pcre           = dependency('libpcre')
diff --git a/sway/commands/exec_always.c b/sway/commands/exec_always.c
index 954950e..ae67823 100644
--- a/sway/commands/exec_always.c
+++ b/sway/commands/exec_always.c
@@ -11,6 +11,7 @@
 #include "log.h"
 #include "stringop.h"
 
+
 struct cmd_results *cmd_exec_always(int argc, char **argv) {
 	struct cmd_results *error = NULL;
 	if (!config->active) return cmd_results_new(CMD_DEFER, NULL, NULL);
@@ -51,7 +52,44 @@ struct cmd_results *cmd_exec_always(int argc, char **argv) {
 	if ((pid = fork()) == 0) {
 		// Fork child process again
 		setsid();
+
 		if ((*child = fork()) == 0) {
+			// Acquire the current PATH
+			char *path = getenv("PATH");
+			const char *extra_path = ":" SWAY_LIBEXECDIR;
+			const size_t extra_size = sizeof(SWAY_LIBEXECDIR) + 1;
+
+			if (!path) {
+				size_t n = confstr(_CS_PATH, NULL, 0);
+				path = malloc(n + extra_size);
+				if (!path) {
+					wlr_log(L_ERROR, "exec_always: Unable to allocate PATH");
+					exit(EXIT_FAILURE);
+				}
+				confstr(_CS_PATH, path, n);
+
+			} else {
+				size_t n = strlen(path) + 1;
+				char *tmp = malloc(n + extra_size);
+				if (!tmp) {
+					wlr_log(L_ERROR, "exec_always: Unable to allocate PATH");
+					exit(EXIT_FAILURE);
+				}
+
+				strncpy(tmp, path, n);
+				path = tmp;
+			}
+
+			// Append /usr/lib/sway to PATH
+			strcat(path, extra_path);
+			if (!setenv("PATH", path, 1)) {
+				free(path);
+				wlr_log(L_ERROR, "exec_always: Unable to set PATH");
+				exit(EXIT_FAILURE);
+			}
+			free(path);
+
+			// Execute the command
 			execl("/bin/sh", "/bin/sh", "-c", cmd, (void *)NULL);
 			// Not reached
 		}
diff --git a/swaybar/meson.build b/swaybar/meson.build
index d65edb1..41c81a8 100644
--- a/swaybar/meson.build
+++ b/swaybar/meson.build
@@ -24,5 +24,6 @@ executable(
 		wlroots,
 	],
 	link_with: [lib_sway_common, lib_sway_client],
-	install: true
+	install: true,
+	install_dir: sway_libexecdir
 )
diff --git a/swaybg/meson.build b/swaybg/meson.build
index 8704de6..716178d 100644
--- a/swaybg/meson.build
+++ b/swaybg/meson.build
@@ -14,5 +14,6 @@ executable(
 		wlroots,
 	],
 	link_with: [lib_sway_common, lib_sway_client],
-	install: true
+	install: true,
+	install_dir: sway_libexecdir
 )
